<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Malla Curricular Arquitectura</title>
<style>
body {
  font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
  background-color: #f8f9f3;
  margin: 0;
  padding: 20px;
  color: #333;
}
h1 {text-align:center;color:#6b8e23;margin-bottom:10px;}

/* Barra de progreso */
.progreso-container {
  width: 90%; max-width:900px; margin:0 auto 15px; text-align:center;
}
.progreso-bar {width:100%; background:#e2ecd7; border-radius:12px; overflow:hidden; height:20px; margin-bottom:5px;}
.progreso-fill {
  height:100%; width:0%; background:#556b2f; transition: width 0.5s ease;
}
.mensaje-motivacion {font-size:0.95em; color:#556b2f; margin-bottom:10px;}
button {
  background:#6b8e23; color:white; border:none; border-radius:10px;
  padding:8px 16px; cursor:pointer; margin-bottom:20px; transition:0.3s;
}
button:hover {background:#556b2f;}

/* Login Box */
#authBox, #userBox{
  max-width:450px; margin:0 auto 20px; padding:15px; border-radius:12px;
  background:#eef5e6; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
input {width:90%; padding:8px; border-radius:8px; border:1px solid #ccc; margin-bottom:10px;}

/* Aﾃ前S */
.anio {min-width:220px;background:#e8f0e2;border-radius:12px;padding:15px;flex-shrink:0;display:flex;flex-direction:column;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,0.05);}
.anio h2 {text-align:center;color:#556b2f;margin-bottom:10px;font-weight:bold;font-size:1.1em;border-bottom:1px solid #a0b78e;width:80%;padding-bottom:5px;}

/* SEMESTRES */
.semestre {display:flex;flex-direction:column;align-items:center;background:#f0f6ed;border-radius:12px;padding:8px;margin-bottom:15px;width:90%;box-shadow:inset 0 0 3px rgba(0,0,0,0.05);}
.semestre h3 {text-align:center;font-size:1em;margin-bottom:8px;font-weight:bold;background:#d8e3c7;padding:4px 0;border-radius:8px;width:100%;}

/* MATERIAS */
.materia {
  background:#d8e3c7; margin:4px 0; padding:6px; border-radius:8px;
  cursor:pointer; transition: all 0.3s ease; text-align:center; width:95%;
  transform: scale(1);
}
.materia.aprobada {
  background:#556b2f; color:white; text-decoration:line-through;
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.materia.bloqueada {background:#cfcfcf; cursor:not-allowed; opacity:.7; transform: scale(1);}
.materia[data-tooltip]:hover::after {
  content:attr(data-tooltip); position:absolute; top:-30px; left:50%; transform:translateX(-50%);
  background:#556b2f; color:white; padding:5px 8px; border-radius:6px; font-size:.8em;
}
.materia[data-tooltip]:hover::before {
  content:''; position:absolute; top:-10px; left:50%; transform:translateX(-50%);
  border-width:5px; border-style:solid; border-color:#556b2f transparent transparent transparent;
}

/* MALLA */
.malla {display:flex;gap:20px;overflow-x:auto;padding:20px;scroll-behavior:smooth;}
</style>
</head>
<body>

<h1>MALLA CURRICULAR ARQUITECTURA</h1>

<!-- Login -->
<div id="authBox">
  <h3>Inicia sesiﾃｳn para guardar tu progreso</h3>
  <input id="email" type="email" placeholder="Correo">
  <input id="pass" type="password" placeholder="Contraseﾃｱa">
  <button id="loginBtn">Ingresar</button>
  <button id="registerBtn">Crear cuenta</button>
  <button id="googleBtn">Continuar con Google</button>
  <button id="recoverBtn">Recuperar contraseﾃｱa</button>
</div>

<div id="userBox" style="display:none;">
  <p>Sesiﾃｳn iniciada como: <strong id="userEmail"></strong></p>
  <button id="logoutBtn">Cerrar sesiﾃｳn</button>
</div>

<!-- Contenido protegido -->
<div id="appContent" style="display:none;">
  <div class="progreso-container">
    <div class="progreso-bar"><div class="progreso-fill" id="progresoFill"></div></div>
    <div id="porcentajeProgreso">Progreso: 0%</div>
    <div class="mensaje-motivacion" id="mensajeMotivacion">Todo gran proyecto empieza con una idea 沍ｱ</div>
    <button id="reiniciarBtn">Reiniciar progreso</button>
  </div>
  <div class="malla" id="malla"></div>
</div>

<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDGFEsBWnEHP3luKaeaFzUe_Nguqz3j_pA",
    authDomain: "malla-curricular-arquitectura.firebaseapp.com",
    projectId: "malla-curricular-arquitectura",
    storageBucket: "malla-curricular-arquitectura.firebasestorage.app",
    messagingSenderId: "613677284410",
    appId: "1:613677284410:web:9ac0d5248cd643af378903",
    measurementId: "G-7LZDWT3DM7"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

/* Referencias UI */
const email = document.getElementById("email");
const pass = document.getElementById("pass");
const loginBtn = document.getElementById("loginBtn");
const registerBtn = document.getElementById("registerBtn");
const googleBtn = document.getElementById("googleBtn");
const recoverBtn = document.getElementById("recoverBtn");
const logoutBtn = document.getElementById("logoutBtn");
const authBox = document.getElementById("authBox");
const userBox = document.getElementById("userBox");
const userEmail = document.getElementById("userEmail");
const appContent = document.getElementById("appContent");

/* Login y registro */
loginBtn.onclick = async()=>{try{await signInWithEmailAndPassword(auth,email.value,pass.value);}catch(e){alert(e.message);}}
registerBtn.onclick = async()=>{try{await createUserWithEmailAndPassword(auth,email.value,pass.value); alert("Cuenta creada");}catch(e){alert(e.message);}}
googleBtn.onclick = async()=>{try{await signInWithPopup(auth,new GoogleAuthProvider());}catch(e){alert(e.message);}}
recoverBtn.onclick = async()=>{try{await sendPasswordResetEmail(auth,email.value); alert("Correo enviado");}catch(e){alert(e.message);}}
logoutBtn.onclick = ()=>signOut(auth);

/* Malla de ejemplo (simplificada, reemplaza con tu data completa) */
const mallaData = [
  /* ---------- PRIMER Aﾃ前 ---------- */
  {
    anio: "Aﾃ前 1",
    semestres: [
      {
        nombre: "1ﾂｰ SEMESTRE",
        materias: [
          { nombre: "Diseﾃｱo Arquitectﾃｳnico 1", prereq: [] },
          { nombre: "Composiciﾃｳn Arquitectﾃｳnica 1", prereq: [] },
          { nombre: "Introducciﾃｳn A La Teorﾃｭa", prereq: [] },
          { nombre: "Arte: Antigﾃｼedad A S. XVIII", prereq: [] },
          { nombre: "Representaciﾃｳn Arquitectﾃｳnica 1", prereq: [] },
          { nombre: "Introducciﾃｳn A La Edificaciﾃｳn", prereq: [] },
          { nombre: "Matemﾃ｡tica Aplicada", prereq: [] },
        ]
      },
      {
        nombre: "2ﾂｰ SEMESTRE",
        materias: [
          { nombre: "Fﾃｭsica Aplicada", prereq: ["Matemﾃ｡tica Aplicada"] },
          { nombre: "Diseﾃｱo Arquitectﾃｳnico 2", prereq: ["Diseﾃｱo Arquitectﾃｳnico 1","Composiciﾃｳn Arquitectﾃｳnica 1","Introducciﾃｳn A La Teorﾃｭa","Representaciﾃｳn Arquitectﾃｳnica 1","Introducciﾃｳn A La Edificaciﾃｳn"] },
          { nombre: "Composiciﾃｳn Arquitectﾃｳnica 2", prereq: ["Composiciﾃｳn Arquitectﾃｳnica 1","Diseﾃｱo Arquitectﾃｳnico 1"] },
          { nombre: "Sistemas Constructivos Bﾃ｡sicos", prereq: ["Introducciﾃｳn A La Edificaciﾃｳn"] },
          { nombre: "Arte: Moderno Y Contemporﾃ｡neo", prereq: ["Arte: Antigﾃｼedad A S. XVIII"] },
          { nombre: "Topografﾃｭa", prereq: ["Introducciﾃｳn A La Edificaciﾃｳn","Matemﾃ｡tica Aplicada"] },
          { nombre: "Dibujo A Mano Alzada", prereq: [] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De Diseﾃｱo Arquitectﾃｳnico 1", prereq: ["Representaciﾃｳn Arquitectﾃｳnica 1","Diseﾃｱo Arquitectﾃｳnico 2"] },
          { nombre: "Taller De Visualizaciﾃｳn", prereq: [] },
          { nombre: "Geomﾃ｡tica", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- SEGUNDO Aﾃ前 ---------- */
  {
    anio: "Aﾃ前 2",
    semestres: [
      {
        nombre: "1ﾂｰ SEMESTRE",
        materias: [
          { nombre: "Espaﾃｱol", prereq: [] },
          { nombre: "Diseﾃｱo Arquitectﾃｳnico 3", prereq: ["Introducciﾃｳn A La Teorﾃｭa","Diseﾃｱo Arquitectﾃｳnico 2","Composiciﾃｳn Arquitectﾃｳnica 2","Sistemas Constructivos Bﾃ｡sicos","Topografﾃｭa","Taller De Diseﾃｱo Arquitectﾃｳnico 1"] },
          { nombre: "Interpretaciﾃｳn De La Arquitectura", prereq: ["Introducciﾃｳn A La Teorﾃｭa"] },
          { nombre: "Representaciﾃｳn Arquitectﾃｳnica 2", prereq: ["Representaciﾃｳn Arquitectﾃｳnica 1"] },
          { nombre: "Tecnologﾃｭa Del Hormigﾃｳn Armado", prereq: ["Introducciﾃｳn A La Edificaciﾃｳn","Sistemas Constructivos Bﾃ｡sicos"] },
          { nombre: "Modelos Estructurales", prereq: ["Fﾃｭsica Aplicada"] },
          { nombre: "Introducciﾃｳn A La Investigaciﾃｳn", prereq: [] },
        ]
      },
      {
        nombre: "2ﾂｰ SEMESTRE",
        materias: [
          { nombre: "Inglﾃｩs", prereq: [] },
          { nombre: "Sociedad Medio Ambiente Y Des.", prereq: ["Diseﾃｱo Arquitectﾃｳnico 3","Introducciﾃｳn A La Edificaciﾃｳn"] },
          { nombre: "Diseﾃｱo Arquitectﾃｳnico 4", prereq: ["Diseﾃｱo Arquitectﾃｳnico 3","Interpretaciﾃｳn De La Arquitectura","Representaciﾃｳn Arquitectﾃｳnica 2","Tecnologﾃｭa Del Hormigﾃｳn Armado"] },
          { nombre: "Textos Y Contextos De La Arq. Latinoamericana", prereq: ["Interpretaciﾃｳn De La Arquitectura"] },
          { nombre: "Representaciﾃｳn Arquitectﾃｳnica 3 La Arquitectura", prereq: ["Representaciﾃｳn Arquitectﾃｳnica 2"] },
          { nombre: "Sistemas Constructivos Especiales", prereq: ["Tecnologﾃｭa Del Hormigﾃｳn Armado"] },
          { nombre: "Anﾃ｡lisis Estructural", prereq: ["Modelos Estructurales"] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De Diseﾃｱo Arquitectﾃｳnico 2", prereq: ["Taller De Diseﾃｱo Arquitectﾃｳnico 1","Diseﾃｱo Arquitectﾃｳnico 4","Representaciﾃｳn Arquitectﾃｳnica 3 La Arquitectura","Sistemas Constructivos Especiales"] },
          { nombre: "Electiva 1", prereq: [] },
          { nombre: "Electiva 2", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- TERCER Aﾃ前 ---------- */
  {
    anio: "Aﾃ前 3",
    semestres: [
      {
        nombre: "1ﾂｰ SEMESTRE",
        materias: [
          { nombre: "Historia De Pma En El Mundo Global", prereq: [] },
          { nombre: "Diseﾃｱo Arquitectﾃｳnico 5", prereq: ["Diseﾃｱo Arquitectﾃｳnico 4","Textos Y Contextos De La Arq. Latinoamericana","Representaciﾃｳn Arquitectﾃｳnica 3 La Arquitectura","Sistemas Constructivos Especiales","Taller De Diseﾃｱo Arquitectﾃｳnico 2"] },
          { nombre: "Crﾃｭtica De La Arquitectura Y Pensamiento Contemporﾃ｡neo", prereq: ["Textos Y Contextos De La Arq. Latinoamericana"] },
          { nombre: "Representaciﾃｳn Arquitectﾃｳnica 4", prereq: ["Representaciﾃｳn Arquitectﾃｳnica 3 La Arquitectura"] },
          { nombre: "Sistema Constructivos Complejos", prereq: ["Sistemas Constructivos Especiales"] },
          { nombre: "Instalaciones Para Edificio 1", prereq: ["Fﾃｭsica Aplicada"] },
          { nombre: "Espacios Abiertos Vecinales", prereq: ["Sociedad Medio Ambiente Y Des.","Topografﾃｭa","Introducciﾃｳn A La Investigaciﾃｳn","Diseﾃｱo Arquitectﾃｳnico 4"] },
        ]
      },
      {
        nombre: "2ﾂｰ SEMESTRE",
        materias: [
          { nombre: "Geografﾃｭa De Panamﾃ｡", prereq: [] },
          { nombre: "Diseﾃｱo Arquitectﾃｳnico 6", prereq: ["Diseﾃｱo Arquitectﾃｳnico 5","Crﾃｭtica De La Arquitectura Y Pensamiento Contemporﾃ｡neo","Representaciﾃｳn Arquitectﾃｳnica 4","Sistema Constructivos Complejos","Instalaciones Para Edificio 1"] },
          { nombre: "Arquitectura Y Ciudad 1", prereq: ["Arte: Moderno Y Contemporﾃ｡neo"] },
          { nombre: "Representaciﾃｳn Arquitectﾃｳnica 5", prereq: ["Representaciﾃｳn Arquitectﾃｳnica 4"] },
          { nombre: "Gestiﾃｳn De Seguridad Y Salud Ocupacional", prereq: ["Sistema Constructivos Complejos"] },
          { nombre: "Instalaciones Para Edificio 2", prereq: ["Instalaciones Para Edificio 1"] },
          { nombre: "Ciudad Y Comunidad", prereq: ["Diseﾃｱo Arquitectﾃｳnico 5","Espacios Abiertos Vecinales"] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De Diseﾃｱo Arquitectﾃｳnico 3", prereq: ["Taller De Diseﾃｱo Arquitectﾃｳnico 2","Sistema Constructivos Complejos","Diseﾃｱo Arquitectﾃｳnico 5","Representaciﾃｳn Arquitectﾃｳnica 5"] },
          { nombre: "Prﾃ｡ctica Supervisada 1", prereq: ["Gestiﾃｳn De Seguridad Y Salud Ocupacional"] },
          { nombre: "Optativa 1", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- CUARTO Aﾃ前 ---------- */
  {
    anio: "Aﾃ前 4",
    semestres: [
      {
        nombre: "1ﾂｰ SEMESTRE",
        materias: [
          { nombre: "Diseﾃｱo Arquitectﾃｳnico 7", prereq: ["Sistema Constructivos Complejos","Diseﾃｱo Arquitectﾃｳnico 6","Instalaciones Para Edificio 2","Taller De Diseﾃｱo Arquitectﾃｳnico 3","Representaciﾃｳn Arquitectﾃｳnica 5"] },
          { nombre: "Arquitectura Y Ciudad 2", prereq: ["Sistema Constructivos Complejos","Diseﾃｱo Arquitectﾃｳnico 6","Instalaciones Para Edificio 2","Taller De Diseﾃｱo Arquitectﾃｳnico 3","Representaciﾃｳn Arquitectﾃｳnica 5"] },
          { nombre: "Representaciﾃｳn Arquitectﾃｳnica 6", prereq: ["Representaciﾃｳn Arquitectﾃｳnica 5"] },
          { nombre: "Taller De Planos Y Especificaciones", prereq: ["Introducciﾃｳn A La Investigaciﾃｳn"] },
          { nombre: "Diseﾃｱo Estructural Simplificado", prereq: ["Anﾃ｡lisis Estructural","Sistema Constructivos Complejos"] },
          { nombre: "Instalaciones Para Edificas 3", prereq: ["Instalaciones Para Edificio 2"] },
          { nombre: "Urbanismo", prereq: ["Geomﾃ｡tica","Diseﾃｱo Arquitectﾃｳnico 6","Ciudad Y Comunidad"] },
        ]
      },
      {
        nombre: "2ﾂｰ SEMESTRE",
        materias: [
          { nombre: "Diseﾃｱo Arquitectﾃｳnico 8", prereq: ["Diseﾃｱo Arquitectﾃｳnico 7","Representaciﾃｳn Arquitectﾃｳnica 6","Diseﾃｱo Estructural Simplificado","Instalaciones Para Edificios 3"] },
          { nombre: "Arquitectura Y Ciudad 3", prereq: ["Arquitectura Y Ciudad 2"] },
          { nombre: "Presupuesto De Obra", prereq: ["Sistema Constructivos Complejos","Taller De Planos Y Especificaciones"] },
          { nombre: "Estructuras Especiales", prereq: ["Diseﾃｱo Estructural Simplificado"] },
          { nombre: "Instalaciones Para Edificios 4", prereq: ["Instalaciones Para Edificas 3"] },
          { nombre: "Espacios Abiertos Urbanos", prereq: ["Diseﾃｱo Arquitectﾃｳnico 7","Urbanismo"] },
          { nombre: "Metodologﾃｭa Para La Elab. De Tesis", prereq: ["Diseﾃｱo Arquitectﾃｳnico 7","Arquitectura Y Ciudad 2","Representaciﾃｳn Arquitectﾃｳnica 6","Taller De Planos Y Especificaciones","Diseﾃｱo Estructural Simplificado","Instalaciones Para Edificio 3","Urbanismo"] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De Urbanismo", prereq: ["Diseﾃｱo Arquitectﾃｳnico 8","Espacios Abiertos Urbanos"] },
          { nombre: "Prﾃ｡ctica Supervisada 2", prereq: ["Prﾃ｡ctica Supervisada 1"] },
          { nombre: "Optativa 2", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- QUINTO Aﾃ前 ---------- */
  {
    anio: "Aﾃ前 5",
    semestres: [
      {
        nombre: "1ﾂｰ SEMESTRE",
        materias: [
          { nombre: "Hist. De Las Relaciones De Pma Con Los EE.UU. I", prereq: [] },
          { nombre: "Diseﾃｱo Arquitectﾃｳnico 9", prereq: ["Diseﾃｱo Arquitectﾃｳnico 8","Estructuras Especiales","Instalaciones Para Edificios 4"] },
          { nombre: "Arquitectura Y Ciudad 4", prereq: ["Arquitectura Y Ciudad 3"] },
          { nombre: "Programaciﾃｳn Y Control De PYT", prereq: ["Taller De Planos Y Especificaciones","Presupuesto De Obra"] },
          { nombre: "Gestiﾃｳn Profesional", prereq: ["Diseﾃｱo Arquitectﾃｳnico 8","Prﾃ｡ctica Supervisada 2"] },
          { nombre: "Ciudad Y Territorio", prereq: ["Taller De Urbanismo"] },
          { nombre: "Trabajo De Graduaciﾃｳn 1", prereq: ["Diseﾃｱo Arquitectﾃｳnico 7","Arquitectura Y Ciudad 3","Representaciﾃｳn Arquitectﾃｳnica 6","Taller De Planos Y Especificaciones","Diseﾃｱo Estructural Simplificado","Instalaciones Para Edificios 3","Urbanismo"] },
        ]
      },
      {
        nombre: "2ﾂｰ SEMESTRE",
        materias: [
          { nombre: "Hist. De Las Relaciones De Pma Con Los EE.UU. II", prereq: [] },
          { nombre: "Diseﾃｱo Arquitectﾃｳnico 10", prereq: ["Diseﾃｱo Arquitectﾃｳnico 9"] },
          { nombre: "Patrimonio Arquitectﾃｳnico", prereq: ["Arquitectura Y Ciudad 4"] },
          { nombre: "Gestiﾃｳn Y Mantenimiento De Edificios", prereq: ["Prﾃ｡ctica Supervisada 2","Programaciﾃｳn Y Control De PYT"] },
          { nombre: "Prﾃ｡ctica Supervisada 3", prereq: ["Representaciﾃｳn Arquitectﾃｳnica 6","Prﾃ｡ctica Supervisada 2","Diseﾃｱo Arquitectﾃｳnico 9","Programaciﾃｳn Y Control De PYT","Gestiﾃｳn Profesional","Ciudad Y Territorio"] },
          { nombre: "Gestiﾃｳn Urbana Y Territorial", prereq: ["Taller De Urbanismo","Diseﾃｱo Arquitectﾃｳnico 9","Gestiﾃｳn Profesional","Ciudad Y Territorio"] },
          { nombre: "Trabajo De Graduaciﾃｳn 2", prereq: ["Trabajo De Graduaciﾃｳn 1"] },
        ]
      }
    ]
  }
];


/* Variables */
let userId = null;
let unsubscribe = null;

/* Funciones Firestore */
async function guardarProgresoFS(nombre, aprobado){
  if(!userId) return;
  const userDoc = doc(db,"usuarios",userId);
  await setDoc(userDoc,{[nombre]:aprobado},{merge:true});
}

/* Render malla */
async function renderMalla(progress){
  const malla = document.getElementById("malla");
  malla.innerHTML="";
  mallaData.forEach(anioData=>{
    const anioDiv=document.createElement("div"); anioDiv.classList.add("anio");
    const h2=document.createElement("h2"); h2.textContent=anioData.anio; anioDiv.appendChild(h2);

    anioData.semestres.forEach(semestre=>{
      const semDiv=document.createElement("div"); semDiv.classList.add("semestre");
      const h3=document.createElement("h3"); h3.textContent=semestre.nombre; semDiv.appendChild(h3);

      semestre.materias.forEach(materia=>{
        const matDiv=document.createElement("div"); matDiv.classList.add("materia"); matDiv.textContent=materia.nombre;

        if(progress[materia.nombre]) matDiv.classList.add("aprobada");
        if(!materia.prereq.every(p=>progress[p]) && !progress[materia.nombre]){
          matDiv.classList.add("bloqueada");
          const faltantes=materia.prereq.filter(p=>!progress[p]);
          matDiv.setAttribute("data-tooltip",`Faltan: ${faltantes.join(", ")}`);
        }

        matDiv.addEventListener("click", async()=>{
          if(!materia.prereq.every(p=>progress[p])) return;
          const aprobado = !progress[materia.nombre];
          await guardarProgresoFS(materia.nombre,aprobado);
        });

        semDiv.appendChild(matDiv);
      });
      anioDiv.appendChild(semDiv);
    });
    malla.appendChild(anioDiv);
  });

  // Actualiza progreso
  const aprobadas = Object.values(progress).filter(v=>v===true).length;
  const total = mallaData.reduce((t,a)=>t+a.semestres.reduce((s,sem)=>s+sem.materias.length,0),0);
  const porcentaje = Math.round((aprobadas/total)*100);
  document.getElementById("porcentajeProgreso").textContent=`Progreso: ${porcentaje}%`;
  document.getElementById("progresoFill").style.width=`${porcentaje}%`;
});

/* Botﾃｳn reiniciar */
document.getElementById("reiniciarBtn").addEventListener("click", async ()=>{
  if(!userId) return;
  if(confirm("ﾂｿReiniciar progreso?")){
    const userDoc = doc(db,"usuarios",userId);
    await setDoc(userDoc,{}, {merge:true});
  }
});

/* Sesiﾃｳn activa */
onAuthStateChanged(auth,user=>{
  if(user){
    authBox.style.display="none";
    userBox.style.display="block";
    appContent.style.display="block";
    userEmail.textContent=user.email;
    userId = user.uid;

    // 沐･ Real-time listener para progreso
    if(unsubscribe) unsubscribe(); // elimina listener anterior
    const userDoc = doc(db,"usuarios",userId);
    unsubscribe = onSnapshot(userDoc, docSnap=>{
      const progress = docSnap.exists()? docSnap.data(): {};
      renderMalla(progress);
    });

  }else{
    authBox.style.display="block";
    userBox.style.display="none";
    appContent.style.display="none";
    userId=null;
    if(unsubscribe) unsubscribe();
  }
});
</script>
</body>
</html>
