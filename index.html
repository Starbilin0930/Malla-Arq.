<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malla Curricular Arquitectura ‚ú®</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Quicksand:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --verde-fondo: #f4f7f0;
            --verde-fuente: #4c662b;
            --verde-primario: #a3c585;
            --verde-oscuro: #6b8e23;
            --blanco: #ffffff;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--verde-fondo);
            margin: 0;
            color: var(--verde-fuente);
            background-image: radial-gradient(#dce6d1 0.5px, transparent 0.5px);
            background-size: 20px 20px;
        }

        #loginScreen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--verde-fondo);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000;
        }

        .login-card {
            background: var(--blanco);
            padding: 50px;
            border-radius: 40px;
            box-shadow: 0 15px 35px rgba(107, 142, 35, 0.1);
            text-align: center;
            width: 320px;
            border: 1px solid rgba(163, 197, 133, 0.3);
        }

        .login-card h1 {
            font-family: 'Dancing Script', cursive;
            font-size: 2.8rem;
            color: var(--verde-oscuro);
            margin-bottom: 30px;
        }

        #mainContent { 
            display: none; 
            padding: 20px; 
            text-align: center; 
            animation: fadeIn 0.8s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .titulo-malla {
            font-family: 'Dancing Script', cursive;
            font-size: 3.5rem;
            margin: 40px 0 10px;
            color: var(--verde-oscuro);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.05);
        }

        .progreso-container { margin: 20px auto 40px; max-width: 800px; }
        .barra-bg {
            width: 100%; height: 16px; background-color: #e2ecd7;
            border-radius: 50px; overflow: hidden; margin: 15px 0;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.03);
        }
        .barra-fill { 
            height: 100%; background: linear-gradient(90deg, var(--verde-primario), #b8d59a); 
            width: 0%; transition: width 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }

        .frase-motivadora {
            font-style: italic; font-weight: 300; margin-bottom: 20px;
            color: #88a070; min-height: 1.2em;
        }

        .malla-scroll { display: flex; gap: 30px; overflow-x: auto; padding: 30px; scrollbar-width: none; }
        .anio-card { 
            min-width: 300px; background: rgba(255, 255, 255, 0.6); 
            border-radius: 35px; padding: 25px; 
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: 0 10px 20px rgba(0,0,0,0.02);
        }

        .anio-titulo { 
            font-size: 1.8rem; font-weight: 700; color: var(--verde-oscuro);
            border-bottom: 2px solid #dce6d1; padding-bottom: 10px; margin-bottom: 20px;
        }

        .semestre-label { 
            background: #f0f4eb; padding: 10px; border-radius: 15px; 
            font-size: 0.9rem; font-weight: 700; margin: 20px 0 10px;
        }

        .materia {
            background: var(--blanco); padding: 14px; margin: 10px 0; border-radius: 18px;
            font-size: 0.85rem; cursor: pointer; position: relative; transition: 0.3s;
        }
        .materia.aprobada { background-color: var(--verde-primario) !important; color: white; }
        .materia.bloqueada { color: #bcc7b0; background: #fdfdfd; cursor: not-allowed; }

        .materia::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
            background: rgba(76, 102, 43, 0.9); color: white; padding: 10px 15px; border-radius: 15px;
            font-size: 0.75rem; width: 180px; z-index: 100; opacity: 0; visibility: hidden; transition: 0.3s;
        }
        .materia:hover::after { opacity: 1; visibility: visible; }

        /* --- CORRECCI√ìN DE CLICS AQU√ç --- */
        .controles-flotantes {
            position: fixed; bottom: 30px; right: 30px;
            display: flex; flex-direction: column; gap: 15px; z-index: 3000;
            pointer-events: none; /* Esto permite hacer clic a trav√©s del contenedor */
        }

        .btn-float {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: var(--verde-primario); color: white; font-size: 1.5rem;
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center; transition: 0.3s;
            pointer-events: auto; /* Esto hace que los botones s√≠ sean clicables */
        }
        .btn-float:hover { transform: scale(1.1) rotate(5deg); background: var(--verde-oscuro); }
        
        .btn-float::before {
            content: attr(data-label); position: absolute; right: 75px;
            background: rgba(0,0,0,0.7); color: white; padding: 6px 12px;
            border-radius: 8px; font-size: 0.75rem; white-space: nowrap;
            opacity: 0; transition: 0.3s; pointer-events: none;
        }
        .btn-float:hover::before { opacity: 1; }

        .btn-google { 
            background: white; border: 1px solid #eee; padding: 14px; border-radius: 50px; 
            width: 100%; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-card">
            <h1>Bienvenida ‚ú®</h1>
            <p style="color: #88a070; margin-bottom: 20px;">Tu futuro dise√±o comienza aqu√≠</p>
            <button id="googleBtn" class="btn-google">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" width="18"> Entrar con Google
            </button>
        </div>
    </div>

    <div id="mainContent">
        <h1 class="titulo-malla">Malla Curricular Arquitectura</h1>
        
        <div class="progreso-container">
            <p id="txtProgreso" style="font-weight: 700; margin-bottom: 5px;">Avance: 0%</p>
            <div class="barra-bg"><div id="fillProgreso" class="barra-fill"></div></div>
            <p id="fraseMotivadora" class="frase-motivadora"></p>
            <button id="reiniciarBtn" style="background: none; border: none; color: #aaa; cursor: pointer; font-size: 0.7rem; text-decoration: underline;">Reiniciar mi progreso</button>
        </div>

        <div class="malla-scroll" id="mallaGrid"></div>

        <div class="controles-flotantes">
            <button id="pdfBtn" class="btn-float" data-label="Descargar PDF">üìÑ</button>
            <button id="logoutBtn" class="btn-float" data-label="Cerrar Sesi√≥n" style="background:#d1d9c7; color:#4c662b; font-size: 1.1rem;">‚úï</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBwu2ccI0usOv4c4SmYAKrOMSLZYGh6Mew",
        authDomain: "malla-curricular-de-arq.firebaseapp.com",
        projectId: "malla-curricular-de-arq",
        storageBucket: "malla-curricular-de-arq.firebasestorage.app",
        messagingSenderId: "922660318162",
        appId: "1:922660318162:web:d03fc6ae04a91792e2f60b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let usuarioActual = null;
    let aprobadas = {};

    const mallaData = [
  /* ---------- PRIMER A√ëO ---------- */
  {
    anio: "A√ëO 1",
    semestres: [
      {
        nombre: "1¬∞ SEMESTRE",
        materias: [
          { nombre: "Dise√±o Arquitect√≥nico 1", prereq: [] },
          { nombre: "Composici√≥n Arquitect√≥nica 1", prereq: [] },
          { nombre: "Introducci√≥n A La Teor√≠a", prereq: [] },
          { nombre: "Arte: Antig√ºedad A S. XVIII", prereq: [] },
          { nombre: "Representaci√≥n Arquitect√≥nica 1", prereq: [] },
          { nombre: "Introducci√≥n A La Edificaci√≥n", prereq: [] },
          { nombre: "Matem√°tica Aplicada", prereq: [] },
        ]
      },
      {
        nombre: "2¬∞ SEMESTRE",
        materias: [
          { nombre: "F√≠sica Aplicada", prereq: ["Matem√°tica Aplicada"] },
          { nombre: "Dise√±o Arquitect√≥nico 2", prereq: ["Dise√±o Arquitect√≥nico 1","Composici√≥n Arquitect√≥nica 1","Introducci√≥n A La Teor√≠a","Representaci√≥n Arquitect√≥nica 1","Introducci√≥n A La Edificaci√≥n"] },
          { nombre: "Composici√≥n Arquitect√≥nica 2", prereq: ["Composici√≥n Arquitect√≥nica 1","Dise√±o Arquitect√≥nico 1"] },
          { nombre: "Sistemas Constructivos B√°sicos", prereq: ["Introducci√≥n A La Edificaci√≥n"] },
          { nombre: "Arte: Moderno Y Contempor√°neo", prereq: ["Arte: Antig√ºedad A S. XVIII"] },
          { nombre: "Topograf√≠a", prereq: ["Introducci√≥n A La Edificaci√≥n","Matem√°tica Aplicada"] },
          { nombre: "Dibujo A Mano Alzada", prereq: [] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De Dise√±o Arquitect√≥nico 1", prereq: ["Representaci√≥n Arquitect√≥nica 1","Dise√±o Arquitect√≥nico 2"] },
          { nombre: "Taller De Visualizaci√≥n", prereq: [] },
          { nombre: "Geom√°tica", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- SEGUNDO A√ëO ---------- */
  {
    anio: "A√ëO 2",
    semestres: [
      {
        nombre: "1¬∞ SEMESTRE",
        materias: [
          { nombre: "Espa√±ol", prereq: [] },
          { nombre: "Dise√±o Arquitect√≥nico 3", prereq: ["Introducci√≥n A La Teor√≠a","Dise√±o Arquitect√≥nico 2","Composici√≥n Arquitect√≥nica 2","Sistemas Constructivos B√°sicos","Topograf√≠a","Taller De Dise√±o Arquitect√≥nico 1"] },
          { nombre: "Interpretaci√≥n De La Arquitectura", prereq: ["Introducci√≥n A La Teor√≠a"] },
          { nombre: "Representaci√≥n Arquitect√≥nica 2", prereq: ["Representaci√≥n Arquitect√≥nica 1"] },
          { nombre: "Tecnolog√≠a Del Hormig√≥n Armado", prereq: ["Introducci√≥n A La Edificaci√≥n","Sistemas Constructivos B√°sicos"] },
          { nombre: "Modelos Estructurales", prereq: ["F√≠sica Aplicada"] },
          { nombre: "Introducci√≥n A La Investigaci√≥n", prereq: [] },
        ]
      },
      {
        nombre: "2¬∞ SEMESTRE",
        materias: [
          { nombre: "Ingl√©s", prereq: [] },
          { nombre: "Sociedad Medio Ambiente Y Des.", prereq: ["Dise√±o Arquitect√≥nico 3","Introducci√≥n A La Edificaci√≥n"] },
          { nombre: "Dise√±o Arquitect√≥nico 4", prereq: ["Dise√±o Arquitect√≥nico 3","Interpretaci√≥n De La Arquitectura","Representaci√≥n Arquitect√≥nica 2","Tecnolog√≠a Del Hormig√≥n Armado"] },
          { nombre: "Textos Y Contextos De La Arq. Latinoamericana", prereq: ["Interpretaci√≥n De La Arquitectura"] },
          { nombre: "Representaci√≥n Arquitect√≥nica 3 La Arquitectura", prereq: ["Representaci√≥n Arquitect√≥nica 2"] },
          { nombre: "Sistemas Constructivos Especiales", prereq: ["Tecnolog√≠a Del Hormig√≥n Armado"] },
          { nombre: "An√°lisis Estructural", prereq: ["Modelos Estructurales"] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De Dise√±o Arquitect√≥nico 2", prereq: ["Taller De Dise√±o Arquitect√≥nico 1","Dise√±o Arquitect√≥nico 4","Representaci√≥n Arquitect√≥nica 3 La Arquitectura","Sistemas Constructivos Especiales"] },
          { nombre: "Electiva 1", prereq: [] },
          { nombre: "Electiva 2", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- TERCER A√ëO ---------- */
  {
    anio: "A√ëO 3",
    semestres: [
      {
        nombre: "1¬∞ SEMESTRE",
        materias: [
          { nombre: "Historia De Pma En El Mundo Global", prereq: [] },
          { nombre: "Dise√±o Arquitect√≥nico 5", prereq: ["Dise√±o Arquitect√≥nico 4","Textos Y Contextos De La Arq. Latinoamericana","Representaci√≥n Arquitect√≥nica 3 La Arquitectura","Sistemas Constructivos Especiales","Taller De Dise√±o Arquitect√≥nico 2"] },
          { nombre: "Cr√≠tica De La Arquitectura Y Pensamiento Contempor√°neo", prereq: ["Textos Y Contextos De La Arq. Latinoamericana"] },
          { nombre: "Representaci√≥n Arquitect√≥nica 4", prereq: ["Representaci√≥n Arquitect√≥nica 3 La Arquitectura"] },
          { nombre: "Sistema Constructivos Complejos", prereq: ["Sistemas Constructivos Especiales"] },
          { nombre: "Instalaciones Para Edificio 1", prereq: ["F√≠sica Aplicada"] },
          { nombre: "Espacios Abiertos Vecinales", prereq: ["Sociedad Medio Ambiente Y Des.","Topograf√≠a","Introducci√≥n A La Investigaci√≥n","Dise√±o Arquitect√≥nico 4"] },
        ]
      },
      {
        nombre: "2¬∞ SEMESTRE",
        materias: [
          { nombre: "Geograf√≠a De Panam√°", prereq: [] },
          { nombre: "Dise√±o Arquitect√≥nico 6", prereq: ["Dise√±o Arquitect√≥nico 5","Cr√≠tica De La Arquitectura Y Pensamiento Contempor√°neo","Representaci√≥n Arquitect√≥nica 4","Sistema Constructivos Complejos","Instalaciones Para Edificio 1"] },
          { nombre: "Arquitectura Y Ciudad 1", prereq: ["Arte: Moderno Y Contempor√°neo"] },
          { nombre: "Representaci√≥n Arquitect√≥nica 5", prereq: ["Representaci√≥n Arquitect√≥nica 4"] },
          { nombre: "Gesti√≥n De Seguridad Y Salud Ocupacional", prereq: ["Sistema Constructivos Complejos"] },
          { nombre: "Instalaciones Para Edificio 2", prereq: ["Instalaciones Para Edificio 1"] },
          { nombre: "Ciudad Y Comunidad", prereq: ["Dise√±o Arquitect√≥nico 5","Espacios Abiertos Vecinales"] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De Dise√±o Arquitect√≥nico 3", prereq: ["Taller De Dise√±o Arquitect√≥nico 2","Sistema Constructivos Complejos","Dise√±o Arquitect√≥nico 5","Representaci√≥n Arquitect√≥nica 5"] },
          { nombre: "Pr√°ctica Supervisada 1", prereq: ["Gesti√≥n De Seguridad Y Salud Ocupacional"] },
          { nombre: "Optativa 1", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- CUARTO A√ëO ---------- */
  {
    anio: "A√ëO 4",
    semestres: [
      {
        nombre: "1¬∞ SEMESTRE",
        materias: [
          { nombre: "Dise√±o Arquitect√≥nico 7", prereq: ["Sistema Constructivos Complejos","Dise√±o Arquitect√≥nico 6","Instalaciones Para Edificio 2","Taller De Dise√±o Arquitect√≥nico 3","Representaci√≥n Arquitect√≥nica 5"] },
          { nombre: "Arquitectura Y Ciudad 2", prereq: ["Sistema Constructivos Complejos","Dise√±o Arquitect√≥nico 6","Instalaciones Para Edificio 2","Taller De Dise√±o Arquitect√≥nico 3","Representaci√≥n Arquitect√≥nica 5"] },
          { nombre: "Representaci√≥n Arquitect√≥nica 6", prereq: ["Representaci√≥n Arquitect√≥nica 5"] },
          { nombre: "Taller De Planos Y Especificaciones", prereq: ["Introducci√≥n A La Investigaci√≥n"] },
          { nombre: "Dise√±o Estructural Simplificado", prereq: ["An√°lisis Estructural","Sistema Constructivos Complejos"] },
          { nombre: "Instalaciones Para Edificas 3", prereq: ["Instalaciones Para Edificio 2"] },
          { nombre: "Urbanismo", prereq: ["Geom√°tica","Dise√±o Arquitect√≥nico 6","Ciudad Y Comunidad"] },
        ]
      },
      {
        nombre: "2¬∞ SEMESTRE",
        materias: [
          { nombre: "Dise√±o Arquitect√≥nico 8", prereq: ["Dise√±o Arquitect√≥nico 7","Representaci√≥n Arquitect√≥nica 6","Dise√±o Estructural Simplificado","Instalaciones Para Edificios 3"] },
          { nombre: "Arquitectura Y Ciudad 3", prereq: ["Arquitectura Y Ciudad 2"] },
          { nombre: "Presupuesto De Obra", prereq: ["Sistema Constructivos Complejos","Taller De Planos Y Especificaciones"] },
          { nombre: "Estructuras Especiales", prereq: ["Dise√±o Estructural Simplificado"] },
          { nombre: "Instalaciones Para Edificios 4", prereq: ["Instalaciones Para Edificas 3"] },
          { nombre: "Espacios Abiertos Urbanos", prereq: ["Dise√±o Arquitect√≥nico 7","Urbanismo"] },
          { nombre: "Metodolog√≠a Para La Elab. De Tesis", prereq: ["Dise√±o Arquitect√≥nico 7","Arquitectura Y Ciudad 2","Representaci√≥n Arquitect√≥nica 6","Taller De Planos Y Especificaciones","Dise√±o Estructural Simplificado","Instalaciones Para Edificio 3","Urbanismo"] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De Urbanismo", prereq: ["Dise√±o Arquitect√≥nico 8","Espacios Abiertos Urbanos"] },
          { nombre: "Pr√°ctica Supervisada 2", prereq: ["Pr√°ctica Supervisada 1"] },
          { nombre: "Optativa 2", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- QUINTO A√ëO ---------- */
  {
    anio: "A√ëO 5",
    semestres: [
      {
        nombre: "1¬∞ SEMESTRE",
        materias: [
          { nombre: "Hist. De Las Relaciones De Pma Con Los EE.UU. I", prereq: [] },
          { nombre: "Dise√±o Arquitect√≥nico 9", prereq: ["Dise√±o Arquitect√≥nico 8","Estructuras Especiales","Instalaciones Para Edificios 4"] },
          { nombre: "Arquitectura Y Ciudad 4", prereq: ["Arquitectura Y Ciudad 3"] },
          { nombre: "Programaci√≥n Y Control De PYT", prereq: ["Taller De Planos Y Especificaciones","Presupuesto De Obra"] },
          { nombre: "Gesti√≥n Profesional", prereq: ["Dise√±o Arquitect√≥nico 8","Pr√°ctica Supervisada 2"] },
          { nombre: "Ciudad Y Territorio", prereq: ["Taller De Urbanismo"] },
          { nombre: "Trabajo De Graduaci√≥n 1", prereq: ["Dise√±o Arquitect√≥nico 7","Arquitectura Y Ciudad 3","Representaci√≥n Arquitect√≥nica 6","Taller De Planos Y Especificaciones","Dise√±o Estructural Simplificado","Instalaciones Para Edificios 3","Urbanismo"] },
        ]
      },
      {
        nombre: "2¬∞ SEMESTRE",
        materias: [
          { nombre: "Hist. De Las Relaciones De Pma Con Los EE.UU. II", prereq: [] },
          { nombre: "Dise√±o Arquitect√≥nico 10", prereq: ["Dise√±o Arquitect√≥nico 9"] },
          { nombre: "Patrimonio Arquitect√≥nico", prereq: ["Arquitectura Y Ciudad 4"] },
          { nombre: "Gesti√≥n Y Mantenimiento De Edificios", prereq: ["Pr√°ctica Supervisada 2","Programaci√≥n Y Control De PYT"] },
          { nombre: "Pr√°ctica Supervisada 3", prereq: ["Representaci√≥n Arquitect√≥nica 6","Pr√°ctica Supervisada 2","Dise√±o Arquitect√≥nico 9","Programaci√≥n Y Control De PYT","Gesti√≥n Profesional","Ciudad Y Territorio"] },
          { nombre: "Gesti√≥n Urbana Y Territorial", prereq: ["Taller De Urbanismo","Dise√±o Arquitect√≥nico 9","Gesti√≥n Profesional","Ciudad Y Territorio"] },
          { nombre: "Trabajo De Graduaci√≥n 2", prereq: ["Trabajo De Graduaci√≥n 1"] },
        ]
      }
    ]
  }
];

    onAuthStateChanged(auth, (user) => {
        if (user) {
            usuarioActual = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            onSnapshot(doc(db, "usuarios", user.uid), (snap) => {
                aprobadas = snap.exists() ? snap.data().materias : {};
                renderMalla();
            });
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainContent').style.display = 'none';
        }
    });

    function actualizarFrase(porcentaje) {
        const frases = [
            { p: 0, t: "Todo gran proyecto empieza con una idea üå±" },
            { p: 10, t: "¬°Buen comienzo! Tus primeros trazos est√°n listos ‚ú®" },
            { p: 50, t: "¬°Mitad de carrera! Ya eres casi una experta üèõÔ∏è" },
            { p: 100, t: "¬°Felicidades, Arquitecta! El mundo es tu lienzo üéì" }
        ];
        const fraseActual = [...frases].reverse().find(f => porcentaje >= f.p);
        document.getElementById('fraseMotivadora').textContent = fraseActual.t;
    }

    function renderMalla() {
        const grid = document.getElementById('mallaGrid');
        grid.innerHTML = '';
        let total = 0, numAp = 0;

        mallaData.forEach(anio => {
            const card = document.createElement('div');
            card.className = 'anio-card';
            card.innerHTML = `<div class="anio-titulo">${anio.anio}</div>`;
            
            anio.semestres.forEach(sem => {
                card.innerHTML += `<div class="semestre-label">${sem.nombre}</div>`;
                sem.materias.forEach(m => {
                    total++;
                    const esAprobada = aprobadas[m.nombre];
                    if(esAprobada) numAp++;
                    const bloqueada = !m.prereq.every(p => aprobadas[p]);

                    const mDiv = document.createElement('div');
                    mDiv.className = `materia ${esAprobada ? 'aprobada' : ''} ${bloqueada && !esAprobada ? 'bloqueada' : ''}`;
                    mDiv.textContent = m.nombre;

                    if (bloqueada && !esAprobada) {
                        const faltan = m.prereq.filter(p => !aprobadas[p]);
                        mDiv.setAttribute('data-tooltip', `üîí Faltan: ${faltan.join(", ")}`);
                    } else if (esAprobada) {
                        mDiv.setAttribute('data-tooltip', `‚úÖ Completada`);
                    } else {
                        mDiv.setAttribute('data-tooltip', `üîì Lista para cursar`);
                    }

                    mDiv.onclick = () => { if(!bloqueada || esAprobada) toggleMateria(m.nombre); };
                    card.appendChild(mDiv);
                });
            });
            grid.appendChild(card);
        });

        const porc = Math.round((numAp/total)*100) || 0;
        document.getElementById('fillProgreso').style.width = porc + '%';
        document.getElementById('txtProgreso').textContent = `Avance: ${porc}%`;
        actualizarFrase(porc);
    }

    async function toggleMateria(n) {
        aprobadas[n] ? delete aprobadas[n] : aprobadas[n] = true;
        await setDoc(doc(db, "usuarios", usuarioActual.uid), { materias: aprobadas });
    }

    document.getElementById('googleBtn').onclick = () => signInWithPopup(auth, provider);
    document.getElementById('logoutBtn').onclick = () => signOut(auth);
    document.getElementById('reiniciarBtn').onclick = async () => {
        if(confirm("¬øSegura que quieres borrar tu progreso? ‚ú®"))
            await setDoc(doc(db, "usuarios", usuarioActual.uid), { materias: {} });
    };

    // --- FUNCI√ìN DEL PDF ---
    document.getElementById('pdfBtn').onclick = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.setTextColor(107, 142, 35);
        doc.text("Mi Avance de Carrera - Arquitectura", 20, 20);
        
        const lista = [];
        mallaData.forEach(anio => {
            anio.semestres.forEach(sem => {
                sem.materias.forEach(m => {
                    const estado = aprobadas[m.nombre] ? "Aprobada" : "Pendiente";
                    lista.push([anio.anio, sem.nombre, m.nombre, estado]);
                });
            });
        });

        doc.autoTable({
            startY: 30,
            head: [['A√±o', 'Semestre', 'Materia', 'Estado']],
            body: lista,
            headStyles: { fillColor: [163, 197, 133] }
        });

        doc.save("Mi_Malla_Arquitectura.pdf");
    };
</script>
</body>
</html>
