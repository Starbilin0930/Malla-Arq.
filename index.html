<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malla Curricular Arquitectura - Cloud Sync</title>
    <style>
        :root {
            --verde-oscuro: #6b8e23;
            --verde-medio: #8fb04d;
            --verde-claro: #e2ecd7;
            --fondo: #f8f9f3;
            --google-blue: #4285F4;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--fondo); 
            margin: 0; 
            padding: 10px; 
            color: #333; 
        }
        
        h1 { text-align: center; color: #4a611a; text-transform: uppercase; letter-spacing: 2px; font-size: 1.5rem; margin-top: 20px; }

        /* --- Contenedores de AutenticaciÃ³n --- */
        .auth-container { 
            max-width: 400px; 
            margin: 0 auto 20px; 
            padding: 20px; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            text-align: center; 
        }
        input { width: 85%; padding: 10px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        
        /* BotÃ³n de Google */
        .btn-google {
            background-color: white;
            color: #757575;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 92%;
            margin: 10px auto;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
        }
        .btn-google img { width: 18px; }
        .btn-google:hover { background-color: #f1f1f1; border-color: #ccc; }

        /* --- Barra de Progreso --- */
        .progreso-container { width: 90%; max-width: 800px; margin: 0 auto 30px; text-align: center; }
        .porcentaje-texto { font-weight: bold; margin-bottom: 10px; color: #555; font-size: 1.1em; }
        .progreso-bar { width: 100%; background-color: var(--verde-claro); border-radius: 20px; height: 16px; overflow: hidden; margin-bottom: 10px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .progreso-fill { height: 100%; width: 0%; background-color: var(--verde-medio); transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        #mensajeMotivacion { font-style: italic; color: #666; font-size: 0.95em; margin-bottom: 15px; min-height: 1.2em; }

        /* --- Botones --- */
        button { background-color: var(--verde-oscuro); color: white; border: none; border-radius: 20px; padding: 10px 20px; cursor: pointer; font-weight: bold; transition: 0.3s; margin: 5px; }
        button:hover { background-color: #4a611a; transform: translateY(-1px); }
        .btn-outline { background: transparent; color: var(--verde-oscuro); border: 1px solid var(--verde-oscuro); }
        #reiniciarBtn { background-color: #9eb17a; font-size: 0.85em; padding: 6px 15px; }

        /* --- Malla Estilo Tarjetas --- */
        .malla { display: flex; gap: 20px; overflow-x: auto; padding: 20px; scrollbar-width: thin; }
        .anio { min-width: 280px; background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex-shrink: 0; }
        .anio h2 { text-align: center; color: #4a611a; border-bottom: 2px solid var(--verde-claro); padding-bottom: 10px; font-size: 1.2rem; }
        .semestre h3 { text-align: center; font-size: 0.85em; color: #888; margin-top: 20px; text-transform: uppercase; background: #f9fbf7; padding: 5px; border-radius: 5px; }

        /* --- Materias y Tooltips --- */
        .materia { 
            background: white; border: 1px solid #eee; margin: 8px 0; padding: 12px; border-radius: 10px; 
            cursor: pointer; text-align: center; font-size: 0.85em; position: relative; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; min-height: 40px;
        }
        .materia:hover { border-color: var(--verde-medio); background-color: #fafafa; }
        .materia.aprobada { background: var(--verde-medio) !important; color: white; border-color: var(--verde-oscuro); text-decoration: line-through; }
        .materia.bloqueada { background: #fdfdfd; color: #bbb; cursor: not-allowed; }

        /* Tooltip */
        .materia::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%);
            background: rgba(40, 40, 40, 0.9); color: white; padding: 8px 12px; border-radius: 6px;
            font-size: 0.75rem; width: 180px; z-index: 100; opacity: 0; visibility: hidden; transition: 0.2s; pointer-events: none;
        }
        .materia:hover::after { opacity: 1; visibility: visible; }

        @media (max-width: 768px) {
            .malla { flex-direction: column; align-items: center; }
            .anio { width: 90%; min-width: auto; }
        }
    </style>
</head>
<body>

    <h1>Malla Arquitectura</h1>

    <div id="authBox" class="auth-container">
        <p>Inicia sesiÃ³n para sincronizar tus dispositivos</p>
        
        <button id="googleLoginBtn" class="btn-google">
            <img src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" alt="Google Logo">
            Continuar con Google
        </button>

        <p style="font-size: 0.8em; color: #999; margin: 15px 0;">â€” O usa tu correo â€”</p>
        
        <input id="email" type="email" placeholder="Correo electrÃ³nico">
        <input id="pass" type="password" placeholder="ContraseÃ±a">
        <br>
        <button id="loginBtn">Entrar</button>
        <button id="registerBtn" class="btn-outline">Crear Cuenta</button>
    </div>

    <div id="userBox" class="auth-container" style="display:none;">
        <p>Bienvenido: <span id="userEmail" style="font-weight:bold;"></span></p>
        <button id="logoutBtn" class="btn-outline">Cerrar SesiÃ³n</button>
    </div>

    <div class="progreso-container">
        <p class="porcentaje-texto" id="porcentajeProgreso">Progreso: 0%</p>
        <div class="progreso-bar"><div class="progreso-fill" id="progresoFill"></div></div>
        <div id="mensajeMotivacion">Todo gran proyecto empieza con una idea ðŸŒ±</div>
        <button id="reiniciarBtn">Reiniciar progreso</button>
    </div>

    <div class="malla" id="mallaContainer"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBwu2ccI0usOv4c4SmYAKrOMSLZYGh6Mew",
        authDomain: "malla-curricular-de-arq.firebaseapp.com",
        projectId: "malla-curricular-de-arq",
        storageBucket: "malla-curricular-de-arq.firebasestorage.app",
        messagingSenderId: "922660318162",
        appId: "1:922660318162:web:d03fc6ae04a91792e2f60b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    let usuarioActual = null;
    let aprobadas = {}; 

    // Mensajes motivacionales
    const frasesMotivacionales = [
        { min: 0, msg: "Todo gran proyecto empieza con una idea ðŸŒ±" },
        { min: 15, msg: "Poniendo los primeros cimientos ðŸ—ï¸" },
        { min: 40, msg: "DiseÃ±ando tu futuro, paso a paso ðŸ“" },
        { min: 60, msg: "Â¡Mitad de carrera superada! Vas por buen camino ðŸ›ï¸" },
        { min: 85, msg: "La estructura estÃ¡ sÃ³lida, falta muy poco ðŸŽ¨" },
        { min: 100, msg: "Â¡Felicidades Arquitecto/a! Proyecto completado ðŸŒŸ" }
    ];

   const mallaData = [
  /* ---------- PRIMER AÃ‘O ---------- */
  {
    anio: "AÃ‘O 1",
    semestres: [
      {
        nombre: "1Â° SEMESTRE",
        materias: [
          { nombre: "DiseÃ±o ArquitectÃ³nico 1", prereq: [] },
          { nombre: "ComposiciÃ³n ArquitectÃ³nica 1", prereq: [] },
          { nombre: "IntroducciÃ³n A La TeorÃ­a", prereq: [] },
          { nombre: "Arte: AntigÃ¼edad A S. XVIII", prereq: [] },
          { nombre: "RepresentaciÃ³n ArquitectÃ³nica 1", prereq: [] },
          { nombre: "IntroducciÃ³n A La EdificaciÃ³n", prereq: [] },
          { nombre: "MatemÃ¡tica Aplicada", prereq: [] },
        ]
      },
      {
        nombre: "2Â° SEMESTRE",
        materias: [
          { nombre: "FÃ­sica Aplicada", prereq: ["MatemÃ¡tica Aplicada"] },
          { nombre: "DiseÃ±o ArquitectÃ³nico 2", prereq: ["DiseÃ±o ArquitectÃ³nico 1","ComposiciÃ³n ArquitectÃ³nica 1","IntroducciÃ³n A La TeorÃ­a","RepresentaciÃ³n ArquitectÃ³nica 1","IntroducciÃ³n A La EdificaciÃ³n"] },
          { nombre: "ComposiciÃ³n ArquitectÃ³nica 2", prereq: ["ComposiciÃ³n ArquitectÃ³nica 1","DiseÃ±o ArquitectÃ³nico 1"] },
          { nombre: "Sistemas Constructivos BÃ¡sicos", prereq: ["IntroducciÃ³n A La EdificaciÃ³n"] },
          { nombre: "Arte: Moderno Y ContemporÃ¡neo", prereq: ["Arte: AntigÃ¼edad A S. XVIII"] },
          { nombre: "TopografÃ­a", prereq: ["IntroducciÃ³n A La EdificaciÃ³n","MatemÃ¡tica Aplicada"] },
          { nombre: "Dibujo A Mano Alzada", prereq: [] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De DiseÃ±o ArquitectÃ³nico 1", prereq: ["RepresentaciÃ³n ArquitectÃ³nica 1","DiseÃ±o ArquitectÃ³nico 2"] },
          { nombre: "Taller De VisualizaciÃ³n", prereq: [] },
          { nombre: "GeomÃ¡tica", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- SEGUNDO AÃ‘O ---------- */
  {
    anio: "AÃ‘O 2",
    semestres: [
      {
        nombre: "1Â° SEMESTRE",
        materias: [
          { nombre: "EspaÃ±ol", prereq: [] },
          { nombre: "DiseÃ±o ArquitectÃ³nico 3", prereq: ["IntroducciÃ³n A La TeorÃ­a","DiseÃ±o ArquitectÃ³nico 2","ComposiciÃ³n ArquitectÃ³nica 2","Sistemas Constructivos BÃ¡sicos","TopografÃ­a","Taller De DiseÃ±o ArquitectÃ³nico 1"] },
          { nombre: "InterpretaciÃ³n De La Arquitectura", prereq: ["IntroducciÃ³n A La TeorÃ­a"] },
          { nombre: "RepresentaciÃ³n ArquitectÃ³nica 2", prereq: ["RepresentaciÃ³n ArquitectÃ³nica 1"] },
          { nombre: "TecnologÃ­a Del HormigÃ³n Armado", prereq: ["IntroducciÃ³n A La EdificaciÃ³n","Sistemas Constructivos BÃ¡sicos"] },
          { nombre: "Modelos Estructurales", prereq: ["FÃ­sica Aplicada"] },
          { nombre: "IntroducciÃ³n A La InvestigaciÃ³n", prereq: [] },
        ]
      },
      {
        nombre: "2Â° SEMESTRE",
        materias: [
          { nombre: "InglÃ©s", prereq: [] },
          { nombre: "Sociedad Medio Ambiente Y Des.", prereq: ["DiseÃ±o ArquitectÃ³nico 3","IntroducciÃ³n A La EdificaciÃ³n"] },
          { nombre: "DiseÃ±o ArquitectÃ³nico 4", prereq: ["DiseÃ±o ArquitectÃ³nico 3","InterpretaciÃ³n De La Arquitectura","RepresentaciÃ³n ArquitectÃ³nica 2","TecnologÃ­a Del HormigÃ³n Armado"] },
          { nombre: "Textos Y Contextos De La Arq. Latinoamericana", prereq: ["InterpretaciÃ³n De La Arquitectura"] },
          { nombre: "RepresentaciÃ³n ArquitectÃ³nica 3 La Arquitectura", prereq: ["RepresentaciÃ³n ArquitectÃ³nica 2"] },
          { nombre: "Sistemas Constructivos Especiales", prereq: ["TecnologÃ­a Del HormigÃ³n Armado"] },
          { nombre: "AnÃ¡lisis Estructural", prereq: ["Modelos Estructurales"] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De DiseÃ±o ArquitectÃ³nico 2", prereq: ["Taller De DiseÃ±o ArquitectÃ³nico 1","DiseÃ±o ArquitectÃ³nico 4","RepresentaciÃ³n ArquitectÃ³nica 3 La Arquitectura","Sistemas Constructivos Especiales"] },
          { nombre: "Electiva 1", prereq: [] },
          { nombre: "Electiva 2", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- TERCER AÃ‘O ---------- */
  {
    anio: "AÃ‘O 3",
    semestres: [
      {
        nombre: "1Â° SEMESTRE",
        materias: [
          { nombre: "Historia De Pma En El Mundo Global", prereq: [] },
          { nombre: "DiseÃ±o ArquitectÃ³nico 5", prereq: ["DiseÃ±o ArquitectÃ³nico 4","Textos Y Contextos De La Arq. Latinoamericana","RepresentaciÃ³n ArquitectÃ³nica 3 La Arquitectura","Sistemas Constructivos Especiales","Taller De DiseÃ±o ArquitectÃ³nico 2"] },
          { nombre: "CrÃ­tica De La Arquitectura Y Pensamiento ContemporÃ¡neo", prereq: ["Textos Y Contextos De La Arq. Latinoamericana"] },
          { nombre: "RepresentaciÃ³n ArquitectÃ³nica 4", prereq: ["RepresentaciÃ³n ArquitectÃ³nica 3 La Arquitectura"] },
          { nombre: "Sistema Constructivos Complejos", prereq: ["Sistemas Constructivos Especiales"] },
          { nombre: "Instalaciones Para Edificio 1", prereq: ["FÃ­sica Aplicada"] },
          { nombre: "Espacios Abiertos Vecinales", prereq: ["Sociedad Medio Ambiente Y Des.","TopografÃ­a","IntroducciÃ³n A La InvestigaciÃ³n","DiseÃ±o ArquitectÃ³nico 4"] },
        ]
      },
      {
        nombre: "2Â° SEMESTRE",
        materias: [
          { nombre: "GeografÃ­a De PanamÃ¡", prereq: [] },
          { nombre: "DiseÃ±o ArquitectÃ³nico 6", prereq: ["DiseÃ±o ArquitectÃ³nico 5","CrÃ­tica De La Arquitectura Y Pensamiento ContemporÃ¡neo","RepresentaciÃ³n ArquitectÃ³nica 4","Sistema Constructivos Complejos","Instalaciones Para Edificio 1"] },
          { nombre: "Arquitectura Y Ciudad 1", prereq: ["Arte: Moderno Y ContemporÃ¡neo"] },
          { nombre: "RepresentaciÃ³n ArquitectÃ³nica 5", prereq: ["RepresentaciÃ³n ArquitectÃ³nica 4"] },
          { nombre: "GestiÃ³n De Seguridad Y Salud Ocupacional", prereq: ["Sistema Constructivos Complejos"] },
          { nombre: "Instalaciones Para Edificio 2", prereq: ["Instalaciones Para Edificio 1"] },
          { nombre: "Ciudad Y Comunidad", prereq: ["DiseÃ±o ArquitectÃ³nico 5","Espacios Abiertos Vecinales"] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De DiseÃ±o ArquitectÃ³nico 3", prereq: ["Taller De DiseÃ±o ArquitectÃ³nico 2","Sistema Constructivos Complejos","DiseÃ±o ArquitectÃ³nico 5","RepresentaciÃ³n ArquitectÃ³nica 5"] },
          { nombre: "PrÃ¡ctica Supervisada 1", prereq: ["GestiÃ³n De Seguridad Y Salud Ocupacional"] },
          { nombre: "Optativa 1", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- CUARTO AÃ‘O ---------- */
  {
    anio: "AÃ‘O 4",
    semestres: [
      {
        nombre: "1Â° SEMESTRE",
        materias: [
          { nombre: "DiseÃ±o ArquitectÃ³nico 7", prereq: ["Sistema Constructivos Complejos","DiseÃ±o ArquitectÃ³nico 6","Instalaciones Para Edificio 2","Taller De DiseÃ±o ArquitectÃ³nico 3","RepresentaciÃ³n ArquitectÃ³nica 5"] },
          { nombre: "Arquitectura Y Ciudad 2", prereq: ["Sistema Constructivos Complejos","DiseÃ±o ArquitectÃ³nico 6","Instalaciones Para Edificio 2","Taller De DiseÃ±o ArquitectÃ³nico 3","RepresentaciÃ³n ArquitectÃ³nica 5"] },
          { nombre: "RepresentaciÃ³n ArquitectÃ³nica 6", prereq: ["RepresentaciÃ³n ArquitectÃ³nica 5"] },
          { nombre: "Taller De Planos Y Especificaciones", prereq: ["IntroducciÃ³n A La InvestigaciÃ³n"] },
          { nombre: "DiseÃ±o Estructural Simplificado", prereq: ["AnÃ¡lisis Estructural","Sistema Constructivos Complejos"] },
          { nombre: "Instalaciones Para Edificas 3", prereq: ["Instalaciones Para Edificio 2"] },
          { nombre: "Urbanismo", prereq: ["GeomÃ¡tica","DiseÃ±o ArquitectÃ³nico 6","Ciudad Y Comunidad"] },
        ]
      },
      {
        nombre: "2Â° SEMESTRE",
        materias: [
          { nombre: "DiseÃ±o ArquitectÃ³nico 8", prereq: ["DiseÃ±o ArquitectÃ³nico 7","RepresentaciÃ³n ArquitectÃ³nica 6","DiseÃ±o Estructural Simplificado","Instalaciones Para Edificios 3"] },
          { nombre: "Arquitectura Y Ciudad 3", prereq: ["Arquitectura Y Ciudad 2"] },
          { nombre: "Presupuesto De Obra", prereq: ["Sistema Constructivos Complejos","Taller De Planos Y Especificaciones"] },
          { nombre: "Estructuras Especiales", prereq: ["DiseÃ±o Estructural Simplificado"] },
          { nombre: "Instalaciones Para Edificios 4", prereq: ["Instalaciones Para Edificas 3"] },
          { nombre: "Espacios Abiertos Urbanos", prereq: ["DiseÃ±o ArquitectÃ³nico 7","Urbanismo"] },
          { nombre: "MetodologÃ­a Para La Elab. De Tesis", prereq: ["DiseÃ±o ArquitectÃ³nico 7","Arquitectura Y Ciudad 2","RepresentaciÃ³n ArquitectÃ³nica 6","Taller De Planos Y Especificaciones","DiseÃ±o Estructural Simplificado","Instalaciones Para Edificio 3","Urbanismo"] },
        ]
      },
      {
        nombre: "VERANO",
        materias: [
          { nombre: "Taller De Urbanismo", prereq: ["DiseÃ±o ArquitectÃ³nico 8","Espacios Abiertos Urbanos"] },
          { nombre: "PrÃ¡ctica Supervisada 2", prereq: ["PrÃ¡ctica Supervisada 1"] },
          { nombre: "Optativa 2", prereq: [] },
        ]
      }
    ]
  },
  /* ---------- QUINTO AÃ‘O ---------- */
  {
    anio: "AÃ‘O 5",
    semestres: [
      {
        nombre: "1Â° SEMESTRE",
        materias: [
          { nombre: "Hist. De Las Relaciones De Pma Con Los EE.UU. I", prereq: [] },
          { nombre: "DiseÃ±o ArquitectÃ³nico 9", prereq: ["DiseÃ±o ArquitectÃ³nico 8","Estructuras Especiales","Instalaciones Para Edificios 4"] },
          { nombre: "Arquitectura Y Ciudad 4", prereq: ["Arquitectura Y Ciudad 3"] },
          { nombre: "ProgramaciÃ³n Y Control De PYT", prereq: ["Taller De Planos Y Especificaciones","Presupuesto De Obra"] },
          { nombre: "GestiÃ³n Profesional", prereq: ["DiseÃ±o ArquitectÃ³nico 8","PrÃ¡ctica Supervisada 2"] },
          { nombre: "Ciudad Y Territorio", prereq: ["Taller De Urbanismo"] },
          { nombre: "Trabajo De GraduaciÃ³n 1", prereq: ["DiseÃ±o ArquitectÃ³nico 7","Arquitectura Y Ciudad 3","RepresentaciÃ³n ArquitectÃ³nica 6","Taller De Planos Y Especificaciones","DiseÃ±o Estructural Simplificado","Instalaciones Para Edificios 3","Urbanismo"] },
        ]
      },
      {
        nombre: "2Â° SEMESTRE",
        materias: [
          { nombre: "Hist. De Las Relaciones De Pma Con Los EE.UU. II", prereq: [] },
          { nombre: "DiseÃ±o ArquitectÃ³nico 10", prereq: ["DiseÃ±o ArquitectÃ³nico 9"] },
          { nombre: "Patrimonio ArquitectÃ³nico", prereq: ["Arquitectura Y Ciudad 4"] },
          { nombre: "GestiÃ³n Y Mantenimiento De Edificios", prereq: ["PrÃ¡ctica Supervisada 2","ProgramaciÃ³n Y Control De PYT"] },
          { nombre: "PrÃ¡ctica Supervisada 3", prereq: ["RepresentaciÃ³n ArquitectÃ³nica 6","PrÃ¡ctica Supervisada 2","DiseÃ±o ArquitectÃ³nico 9","ProgramaciÃ³n Y Control De PYT","GestiÃ³n Profesional","Ciudad Y Territorio"] },
          { nombre: "GestiÃ³n Urbana Y Territorial", prereq: ["Taller De Urbanismo","DiseÃ±o ArquitectÃ³nico 9","GestiÃ³n Profesional","Ciudad Y Territorio"] },
          { nombre: "Trabajo De GraduaciÃ³n 2", prereq: ["Trabajo De GraduaciÃ³n 1"] },
        ]
      }
    ]
  }
];
    // --- LÃ³gica de AutenticaciÃ³n ---
    document.getElementById('googleLoginBtn').onclick = () => {
        signInWithPopup(auth, googleProvider).catch(err => alert("Error Google: " + err.message));
    };

    document.getElementById('registerBtn').onclick = () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;
        createUserWithEmailAndPassword(auth, email, pass).catch(err => alert("Error: " + err.message));
    };

    document.getElementById('loginBtn').onclick = () => {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('pass').value;
        signInWithEmailAndPassword(auth, email, pass).catch(err => alert("Error de acceso"));
    };

    document.getElementById('logoutBtn').onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            usuarioActual = user;
            document.getElementById('authBox').style.display = 'none';
            document.getElementById('userBox').style.display = 'block';
            document.getElementById('userEmail').textContent = user.email;
            onSnapshot(doc(db, "usuarios", user.uid), (docSnap) => {
                aprobadas = docSnap.exists() ? docSnap.data().materias : {};
                renderMalla();
            });
        } else {
            usuarioActual = null;
            aprobadas = {};
            document.getElementById('authBox').style.display = 'block';
            document.getElementById('userBox').style.display = 'none';
            renderMalla();
        }
    });

    async function toggleMateria(nombre) {
        if (!usuarioActual) { alert("Â¡Inicia sesiÃ³n para sincronizar!"); return; }
        if (aprobadas[nombre]) { delete aprobadas[nombre]; } else { aprobadas[nombre] = true; }
        await setDoc(doc(db, "usuarios", usuarioActual.uid), { materias: aprobadas });
    }

    function renderMalla() {
        const container = document.getElementById('mallaContainer');
        container.innerHTML = '';
        let totalMat = 0, aprobadasCount = 0;

        mallaData.forEach(anio => {
            const anioDiv = document.createElement('div');
            anioDiv.className = 'anio';
            anioDiv.innerHTML = `<h2>${anio.anio}</h2>`;
            anio.semestres.forEach(sem => {
                const semDiv = document.createElement('div');
                semDiv.className = 'semestre';
                semDiv.innerHTML = `<h3>${sem.nombre}</h3>`;
                sem.materias.forEach(m => {
                    totalMat++;
                    const esAprobada = aprobadas[m.nombre];
                    if(esAprobada) aprobadasCount++;
                    const bloqueada = !m.prereq.every(p => aprobadas[p]);
                    
                    const mDiv = document.createElement('div');
                    mDiv.className = `materia ${esAprobada ? 'aprobada' : ''} ${bloqueada && !esAprobada ? 'bloqueada' : ''}`;
                    mDiv.textContent = m.nombre;

                    // Tooltip dinÃ¡mico
                    if (bloqueada && !esAprobada) {
                        const faltan = m.prereq.filter(p => !aprobadas[p]);
                        mDiv.setAttribute('data-tooltip', `ðŸ”’ Faltan: ${faltan.join(", ")}`);
                    } else if (esAprobada) {
                        mDiv.setAttribute('data-tooltip', `âœ… Completada`);
                    } else {
                        mDiv.setAttribute('data-tooltip', `ðŸ”“ Lista para cursar`);
                    }

                    mDiv.onclick = () => { if (!bloqueada || esAprobada) toggleMateria(m.nombre); };
                    semDiv.appendChild(mDiv);
                });
                anioDiv.appendChild(semDiv);
            });
            container.appendChild(anioDiv);
        });

        const porc = Math.round((aprobadasCount / totalMat) * 100) || 0;
        document.getElementById('progresoFill').style.width = porc + '%';
        document.getElementById('porcentajeProgreso').textContent = `Progreso: ${porc}%`;
        
        const frase = [...frasesMotivacionales].reverse().find(f => porc >= f.min);
        document.getElementById('mensajeMotivacion').textContent = frase ? frase.msg : frasesMotivacionales[0].msg;
    }

    document.getElementById('reiniciarBtn').onclick = async () => {
        if(usuarioActual && confirm("Â¿Deseas reiniciar todo tu progreso en la nube?")) {
            await setDoc(doc(db, "usuarios", usuarioActual.uid), { materias: {} });
        }
    }
</script>
</body>
</html>
