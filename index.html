<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Malla Curricular Arquitectura</title>

<style>
body {
  font-family: 'Arial Rounded MT Bold', Arial, sans-serif;
  background-color: #f8f9f3;
  margin: 0;
  padding: 20px;
  color: #333;
}

h1 {
  text-align: center;
  color: #6b8e23;
  margin-bottom: 10px;
}

/* Barra de progreso */
.progreso-container {
  width: 90%;
  max-width: 900px;
  margin: 0 auto 15px;
  text-align: center;
}

.progreso-bar {
  width: 100%;
  background-color: #e2ecd7;
  border-radius: 12px;
  overflow: hidden;
  height: 20px;
  margin-bottom: 5px;
}

.progreso-fill {
  height: 100%;
  width: 0%;
  background-color: #556b2f;
  transition: width 0.5s ease;
}

.mensaje-motivacion {
  font-size: 0.95em;
  color: #556b2f;
  margin-bottom: 10px;
}

button {
  background-color: #6b8e23;
  color: white;
  border: none;
  border-radius: 10px;
  padding: 8px 16px;
  cursor: pointer;
  margin-bottom: 20px;
  transition: 0.2s;
}

button:hover {
  background-color: #556b2f;
}

/* Login Box */
#authBox, #userBox{
  max-width: 450px;
  margin: 0 auto 20px;
  padding: 15px;
  border-radius: 12px;
  background:#eef5e6;
  text-align:center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

input{
  width:90%;
  padding:8px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-bottom:10px;
}

/* AÃ‘OS */
.anio {
  min-width: 220px;
  background:#e8f0e2;
  border-radius:12px;
  padding:15px;
  flex-shrink:0;
  display:flex;
  flex-direction:column;
  align-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
}

.anio h2 {
  text-align:center;
  color:#556b2f;
  margin-bottom:10px;
  font-weight:bold;
  font-size:1.1em;
  border-bottom:1px solid #a0b78e;
  width:80%;
  padding-bottom:5px;
}

/* SEMESTRES */
.semestre {
  display:flex;
  flex-direction:column;
  align-items:center;
  background:#f0f6ed;
  border-radius:12px;
  padding:8px;
  margin-bottom:15px;
  width:90%;
  box-shadow:inset 0 0 3px rgba(0,0,0,0.05);
}

.semestre h3 {
  text-align:center;
  font-size:1em;
  margin-bottom:8px;
  font-weight:bold;
  background:#d8e3c7;
  padding:4px 0;
  border-radius:8px;
  width:100%;
}

/* MATERIAS */
.materia {
  background:#d8e3c7;
  margin:4px 0;
  padding:6px;
  border-radius:8px;
  cursor:pointer;
  transition:.3s;
  text-align:center;
  width:95%;
}

.materia.aprobada {
  background:#556b2f;
  color:white;
  text-decoration:line-through;
  transform: scale(1.05);
}

.materia.bloqueada {
  background:#cfcfcf;
  cursor:not-allowed;
  opacity:.7;
}

/* Tooltip */
.materia[data-tooltip]:hover::after {
  content:attr(data-tooltip);
  position:absolute;
  top:-30px;
  left:50%;
  transform:translateX(-50%);
  background:#556b2f;
  color:white;
  padding:5px 8px;
  border-radius:6px;
  font-size:.8em;
}

.materia[data-tooltip]:hover::before {
  content:'';
  position:absolute;
  top:-10px;
  left:50%;
  transform:translateX(-50%);
  border-width:5px;
  border-style:solid;
  border-color:#556b2f transparent transparent transparent;
}

/* MALLA */
.malla {
  display:flex;
  gap:20px;
  overflow-x:auto;
  padding:20px;
  scroll-behavior:smooth;
}
</style>
</head>
<body>

<h1>MALLA CURRICULAR ARQUITECTURA</h1>

<!-- Caja de AutenticaciÃ³n -->
<div id="authBox">
  <h3>Inicia sesiÃ³n para guardar tu progreso</h3>
  <input id="email" type="email" placeholder="Correo">
  <input id="pass" type="password" placeholder="ContraseÃ±a">

  <button id="loginBtn">Ingresar</button>
  <button id="registerBtn">Crear cuenta</button>
  <button id="googleBtn">Continuar con Google</button>
  <button id="recoverBtn">Recuperar contraseÃ±a</button>
</div>

<!-- Caja cuando el usuario estÃ¡ logueado -->
<div id="userBox" style="display:none;">
  <p>SesiÃ³n iniciada como: <strong id="userEmail"></strong></p>
  <button id="logoutBtn">Cerrar sesiÃ³n</button>
</div>

<!-- Barra de progreso -->
<div class="progreso-container">
  <div class="progreso-bar">
    <div class="progreso-fill" id="progresoFill"></div>
  </div>
  <div id="porcentajeProgreso">Progreso: 0%</div>
  <div class="mensaje-motivacion" id="mensajeMotivacion">Todo gran proyecto empieza con una idea ðŸŒ±</div>
</div>

<div class="malla" id="malla"></div>

<!-- ================== FIREBASE + MALLA ================== -->
<script type="module">
// ---------------- FIREBASE ----------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { 
  getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail,
  onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

import { 
  getFirestore, doc, setDoc, onSnapshot 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDGFEsBWnEHP3luKaeaFzUe_NGuqz3j_pA",
  authDomain: "malla-curricular-arquitectura.firebaseapp.com",
  projectId: "malla-curricular-arquitectura",
  storageBucket: "malla-curricular-arquitectura.appspot.com",
  messagingSenderId: "613677284410",
  appId: "1:613677284410:web:92297cf4c86a6f6c378903"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Referencias HTML
const email = document.getElementById("email");
const pass = document.getElementById("pass");
const loginBtn = document.getElementById("loginBtn");
const registerBtn = document.getElementById("registerBtn");
const googleBtn = document.getElementById("googleBtn");
const recoverBtn = document.getElementById("recoverBtn");
const logoutBtn = document.getElementById("logoutBtn");
const authBox = document.getElementById("authBox");
const userBox = document.getElementById("userBox");
const userEmail = document.getElementById("userEmail");
const mallaEl = document.getElementById("malla");
const progresoFill = document.getElementById("progresoFill");
const porcentajeProgreso = document.getElementById("porcentajeProgreso");
const mensajeMotivacion = document.getElementById("mensajeMotivacion");

// --------- LOGIN / REGISTRO ---------
loginBtn.onclick = async ()=>{ try{
  await signInWithEmailAndPassword(auth,email.value,pass.value);
  alert("Inicio correcto");
}catch(e){alert(e.message);}}

registerBtn.onclick = async ()=>{ try{
  await createUserWithEmailAndPassword(auth,email.value,pass.value);
  alert("Cuenta creada");
}catch(e){alert(e.message);}};

googleBtn.onclick = async ()=>{ try{
  await signInWithPopup(auth,new GoogleAuthProvider());
}catch(e){alert(e.message);}};

recoverBtn.onclick = async ()=>{ try{
  await sendPasswordResetEmail(auth,email.value);
  alert("Correo enviado");
}catch(e){alert(e.message);}};

logoutBtn.onclick = ()=>signOut(auth);

// ---------------- MALLA DATA ----------------
const mallaData = [ /* Pega aquÃ­ toda la data que me enviaste antes, desde AÃ‘O 1 hasta 5 */ ];

// ---------------- FUNCIONES ----------------
async function guardarProgresoFirebase(userId, materia, aprobado){
  await setDoc(doc(db,"usuarios",userId,"progreso",materia),{aprobada:aprobado},{merge:true});
}

function puedeAprobar(materia, progreso){
  return materia.prereq.every(p=>progreso[p]);
}

function actualizarProgresoUI(progreso){
  let total = 0, aprobadas = 0;
  mallaData.forEach(anio=>{
    anio.semestres.forEach(sem=>{
      sem.materias.forEach(mat=>{
        total++;
        if(progreso[mat.nombre]) aprobadas++;
      });
    });
  });
  const porc = Math.round((aprobadas/total)*100);
  porcentajeProgreso.textContent = `Progreso: ${porc}%`;
  progresoFill.style.width = porc+"%";

  if(porc <= 10) mensajeMotivacion.textContent="Todo gran proyecto empieza con una idea ðŸŒ±";
  else if(porc <=30) mensajeMotivacion.textContent="Vas construyendo tu futuro ladrillo a ladrillo ðŸ§±";
  else if(porc <=60) mensajeMotivacion.textContent="Sigue asÃ­, tu creatividad toma forma ðŸ›ï¸";
  else if(porc <=90) mensajeMotivacion.textContent="Casi lista/o para diseÃ±ar grandes espacios âœ¨";
  else mensajeMotivacion.textContent="Â¡Felicidades arquitecta/o! Tu esfuerzo rindiÃ³ frutos ðŸŽ‰";
}

function renderMalla(userId, progreso){
  mallaEl.innerHTML="";
  mallaData.forEach(anio=>{
    const anioDiv = document.createElement("div"); anioDiv.className="anio";
    const h2 = document.createElement("h2"); h2.textContent=anio.anio; anioDiv.appendChild(h2);

    anio.semestres.forEach(sem=>{
      const semDiv = document.createElement("div"); semDiv.className="semestre";
      const h3 = document.createElement("h3"); h3.textContent=sem.nombre; semDiv.appendChild(h3);

      sem.materias.forEach(mat=>{
        const matDiv = document.createElement("div");
        matDiv.className="materia";
        matDiv.textContent=mat.nombre;

        if(progreso[mat.nombre]) matDiv.classList.add("aprobada");
        if(!puedeAprobar(mat,progreso) && !progreso[mat.nombre]){
          matDiv.classList.add("bloqueada");
          const faltantes = mat.prereq.filter(p=>!progreso[p]);
          matDiv.setAttribute("data-tooltip","Faltan: "+faltantes.join(", "));
        }

        matDiv.style.transition="all 0.3s";
        matDiv.onclick = async ()=>{
          if(!puedeAprobar(mat,progreso)) return;
          progreso[mat.nombre]=!progreso[mat.nombre];
          await guardarProgresoFirebase(userId, mat.nombre, progreso[mat.nombre]);
        }

        semDiv.appendChild(matDiv);
      });

      anioDiv.appendChild(semDiv);
    });

    mallaEl.appendChild(anioDiv);
  });
  actualizarProgresoUI(progreso);
}

// ---------------- SESION ----------------
onAuthStateChanged(auth,user=>{
  if(user){
    authBox.style.display="none";
    userBox.style.display="block";
    userEmail.textContent=user.email;

    const userProgresoRef = doc(db,"usuarios",user.uid);
    onSnapshot(userProgresoRef, snapshot=>{
      const progreso = snapshot.exists()?snapshot.data():{};
      renderMalla(user.uid, progreso);
    });

  }else{
    authBox.style.display="block";
    userBox.style.display="none";
    mallaEl.innerHTML="";
    porcentajeProgreso.style.width="0%";
    mensajeMotivacion.textContent="Todo gran proyecto empieza con una idea ðŸŒ±";
  }
});
</script>

</body>
</html>
